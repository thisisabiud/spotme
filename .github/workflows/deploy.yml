name: Deploy Spotme Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up ssh-agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH to known hosts
        run: ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'EOL'
          #!/bin/bash
          set -e

          mkdir -p /home/spotme

          # Configure git to trust this directory
          git config --global --add safe.directory /home/spotme

          if [ -d /home/spotme/.git ]; then
            cd  /home/spotme
            git pull
          else
            git clone git@github.com:${{ github.repository }}.git /home/spotme
            cd /home/spotme
          fi

          chmod 755 /home/spotme
          chown -R www-data:www-data /home/spotme

          #create and activate virtual environment
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn

          # create .env file
          cat > .env << EOF
          ENVIRONMENT=production
          ALLOWED_HOSTS=${SERVER_NAME}
          DEBUG=False
          EOF

          #apply database migrations
          python manage.py makemigrations
          python manage.py migrate

          #collect static files
          python manage.py collectstatic --noinput

          # create django superuser if not exists
          cat > create_user.py << 'EOPY'
          import os
          os.environ.setdefault('ENVIRONMENT', 'production')
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'spotme.settings')
          import django
          django.setup()
          from django.contrib.auth import get_user_model
          User = get_user_model()
          username = os.getenv('DJANGO_SUPERUSER_USERNAME')
          email = os.getenv('DJANGO_SUPERUSER_EMAIL')
          password = os.getenv('DJANGO_SUPERUSER_PASSWORD')
          if not User.objects.filter(username=username).exists():
              User.objects.create_superuser(username=username, email=email, password=password)
              print(f"Superuser {username} created.")
          else:
              print(f"Superuser {username} already exists.")
          EOPY

          DJANGO_SUPERUSER_USERNAME="${DJANGO_SUPERUSER_USERNAME}" \
          DJANGO_SUPERUSER_EMAIL="${DJANGO_SUPERUSER_EMAIL}" \
          DJANGO_SUPERUSER_PASSWORD="${DJANGO_SUPERUSER_PASSWORD}" \
          python create_user.py
          rm create_user.py

          # CREATE log directory for gunicorn
          sudo mkdir -p /var/log/gunicorn
          sudo chown -R www-data:www-data /var/log/gunicorn

          # create systemd service file for gunicorn
          cat > gunicorn.service << 'EOT'
          [Unit]
          Description=gunicorn daemon for Spotme
          After=network.target

          [Service]
          User=www-data
          Group=www-data
          WorkingDirectory=/home/spotme
          Environment="PATH=/home/spotme/venv/bin"
          Environment="PYTHONPATH=/home/spotme"
          Environment="ENVIRONMENT=production"
          Environment="DJANGO_SETTINGS_MODULE=spotme.settings"
          ExecStart=/home/spotme/venv/bin/gunicorn \
                    --access-logfile /var/log/gunicorn/spotme_access.log \
                    --error-logfile /var/log/gunicorn/spotme_error.log \
                    --workers 3 \
                    --bind unix:/home/spotme/spotme.sock \
                    --chdir /home/spotme \
                    spotme.wsgi:application
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          EOT

          sudo mv gunicorn.service /etc/systemd/system/spotme_gunicorn.service
          sudo systemctl daemon-reload
          sudo systemctl restart spotme_gunicorn || sudo systemctl start spotme_gunicorn
          sudo systemctl enable spotme_gunicorn

          # wait for a few seconds to ensure gunicorn starts
          sleep 5

          # install ssl certificate using certbot
          if [ ! -d "/etc/letsencrypt/live/${SERVER_NAME}" ]; then
            echo "Installing Certbot and obtaining SSL certificate..."
            sudo apt-get update
            sudo apt-get install -y certbot python3-certbot-nginx
          
            # create temporary nginx config for certbot
            cat > spotme_nginx << EOT
          server {
              listen 80;
              server_name ${SERVER_NAME};
              location / {
                  proxy_pass http://unix:/home/spotme/spotme.sock;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
          }
          
          location /static/ {
              alias /home/spotme/staticfiles/;
          }
          
          location /media/ {
              alias /home/spotme/media/;
          }
          EOT
            sudo mv spotme_nginx /etc/nginx/sites-available/spotme
            sudo ln -s /etc/nginx/sites-available/spotme /etc/nginx/sites-enabled
            sudo nginx -t && sudo systemctl reload nginx
          
            # obtain ssl certificate
            sudo certbot --nginx -d ${SERVER_NAME} --non-interactive --agree-tos -m ${ADMIN_EMAIL} --redirect
          else
            echo "SSL certificate already exists. Skipping Certbot installation."
          fi

          # verify nginx configuration and restart nginx
          echo "Verifying Nginx configuration..."
          sudo nginx -t && sudo systemctl restart nginx

          echo "Deployment completed successfully."
          EOL
          chmod +x deploy.sh

      - name: Deploy to Server
        env:
          DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          SERVER_NAME: ${{ secrets.SERVER_NAME }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        run: |
          # copy deployment script to server and execute it
          scp deploy.sh root@${{ secrets.HOST }}:/tmp/deploy.sh 

          # execute deployment script on server with env variables
          ssh root@${{ secrets.HOST }} "SERVER_NAME='$SERVER_NAME' ADMIN_EMAIL='$ADMIN_EMAIL' DJANGO_SUPERUSER_USERNAME='$DJANGO_SUPERUSER_USERNAME' DJANGO_SUPERUSER_EMAIL='$DJANGO_SUPERUSER_EMAIL' DJANGO_SUPERUSER_PASSWORD='$DJANGO_SUPERUSER_PASSWORD' bash /tmp/deploy.sh"

          #clean up
          ssh root@${{ secrets.HOST }} "rm /tmp/deploy.sh"

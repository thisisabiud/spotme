name: Deploy Spotme Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH to Known Hosts
        run: ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Create Deployment Script
        run: |
          cat > deploy.sh << 'EOL'
          #!/bin/bash
          set -e

          echo "Starting deployment..."

          # Setup project directory
          mkdir -p /home/spotme
          git config --global --add safe.directory /home/spotme

          # Clone or pull repository
          if [ -d /home/spotme/.git ]; then
            echo "Repository exists, pulling latest changes..."
            cd /home/spotme
            
            # Stash any local changes (like db.sqlite3)
            echo "Stashing local changes..."
            git stash
            
            # Pull latest changes
            git pull
            
            # Don't pop the stash - we want to keep server's database
          else
            echo "Cloning repository..."
            git clone git@github.com:REPO_PLACEHOLDER /home/spotme
            cd /home/spotme
          fi

          # Create directories early
          echo "Creating application directories..."
          mkdir -p /home/spotme/static
          mkdir -p /home/spotme/staticfiles
          mkdir -p /home/spotme/media
          mkdir -p /home/spotme/media/seat_maps

          # Set permissions - do this AFTER creating directories
          echo "Setting permissions..."
          chmod 755 /home/spotme
          chown -R www-data:www-data /home/spotme
          chmod -R 775 /home/spotme/media
          chmod -R 775 /home/spotme/staticfiles

          # Setup virtual environment
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn

          # Create .env file
          echo "Creating .env file..."
          cat > .env << ENVEOF
          ENVIRONMENT=production
          ALLOWED_HOSTS=${SERVER_NAME}
          DEBUG=False
          ENVEOF

          # Run Django management commands
          echo "Running migrations..."
          python manage.py makemigrations
          python manage.py migrate

          echo "Collecting static files..."
          python manage.py collectstatic --noinput

          # Ensure permissions again after Django commands
          echo "Ensuring correct permissions after Django setup..."
          sudo chown -R www-data:www-data /home/spotme/media
          sudo chown -R www-data:www-data /home/spotme/staticfiles
          sudo chmod -R 775 /home/spotme/media
          sudo chmod -R 775 /home/spotme/staticfiles

          # Create Django superuser
          echo "Creating superuser..."
          cat > create_user.py << 'EOPY'
          import os
          os.environ.setdefault('ENVIRONMENT', 'production')
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'spotme.settings')
          import django
          django.setup()
          from django.contrib.auth import get_user_model

          User = get_user_model()
          username = os.getenv('DJANGO_SUPERUSER_USERNAME')
          email = os.getenv('DJANGO_SUPERUSER_EMAIL')
          password = os.getenv('DJANGO_SUPERUSER_PASSWORD')

          if not username or not email or not password:
              print("Error: Missing superuser credentials in environment variables")
              exit(1)

          if not User.objects.filter(username=username).exists():
              User.objects.create_superuser(username=username, email=email, password=password)
              print(f"Superuser '{username}' created successfully.")
          else:
              print(f"Superuser '{username}' already exists.")
          EOPY

          export DJANGO_SUPERUSER_USERNAME="${DJANGO_SUPERUSER_USERNAME}"
          export DJANGO_SUPERUSER_EMAIL="${DJANGO_SUPERUSER_EMAIL}"
          export DJANGO_SUPERUSER_PASSWORD="${DJANGO_SUPERUSER_PASSWORD}"
          python create_user.py
          rm create_user.py

          # Setup Gunicorn
          echo "Setting up Gunicorn..."
          sudo mkdir -p /var/log/gunicorn
          sudo chown -R www-data:www-data /var/log/gunicorn

          sudo tee /etc/systemd/system/spotme_gunicorn.service > /dev/null << 'SVCEOF'
          [Unit]
          Description=Gunicorn daemon for Spotme
          After=network.target

          [Service]
          User=www-data
          Group=www-data
          WorkingDirectory=/home/spotme
          Environment="PATH=/home/spotme/venv/bin"
          Environment="PYTHONPATH=/home/spotme"
          Environment="ENVIRONMENT=production"
          Environment="DJANGO_SETTINGS_MODULE=spotme.settings"
          ExecStart=/home/spotme/venv/bin/gunicorn \
                    --access-logfile /var/log/gunicorn/spotme_access.log \
                    --error-logfile /var/log/gunicorn/spotme_error.log \
                    --workers 3 \
                    --bind unix:/home/spotme/spotme.sock \
                    --chdir /home/spotme \
                    spotme.wsgi:application
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
          SVCEOF

          sudo systemctl daemon-reload
          sudo systemctl restart spotme_gunicorn || sudo systemctl start spotme_gunicorn
          sudo systemctl enable spotme_gunicorn

          echo "Waiting for Gunicorn to start..."
          sleep 5

          # Setup Nginx and SSL
          if [ ! -d "/etc/letsencrypt/live/${SERVER_NAME}" ]; then
            echo "Setting up Nginx and SSL certificate..."
            sudo apt-get update
            sudo apt-get install -y certbot python3-certbot-nginx

            # Remove old config if exists
            sudo rm -f /etc/nginx/sites-enabled/spotme
            sudo rm -f /etc/nginx/sites-available/spotme

            # Create Nginx configuration
            sudo tee /etc/nginx/sites-available/spotme > /dev/null << 'NGXEOF'
          server {
              listen 80;
              server_name SERVER_NAME_PLACEHOLDER;

              location / {
                  proxy_pass http://unix:/home/spotme/spotme.sock;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /static/ {
                  alias /home/spotme/staticfiles/;
              }

              location /media/ {
                  alias /home/spotme/media/;
              }
          }
          NGXEOF

            # Replace placeholder with actual server name
            sudo sed -i "s/SERVER_NAME_PLACEHOLDER/${SERVER_NAME}/g" /etc/nginx/sites-available/spotme

            # Enable site
            sudo ln -sf /etc/nginx/sites-available/spotme /etc/nginx/sites-enabled/

            # Test and reload Nginx
            sudo nginx -t && sudo systemctl reload nginx

            # Obtain SSL certificate
            echo "Obtaining SSL certificate..."
            sudo certbot --nginx -d ${SERVER_NAME} --non-interactive --agree-tos -m ${ADMIN_EMAIL} --redirect
          else
            echo "SSL certificate already exists."
            # Still reload nginx to pick up any config changes
            sudo nginx -t && sudo systemctl reload nginx
          fi

          # Final permission check
          echo "Final permission verification..."
          sudo chown -R www-data:www-data /home/spotme/media
          sudo chmod -R 775 /home/spotme/media

          echo "Deployment completed successfully!"
          EOL

          # Replace repository placeholder
          sed -i "s|REPO_PLACEHOLDER|${{ github.repository }}|g" deploy.sh
          chmod +x deploy.sh

      - name: Deploy to Server
        env:
          DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          SERVER_NAME: ${{ secrets.SERVER_NAME }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        run: |
          echo "Copying deployment script to server..."
          scp deploy.sh root@${{ secrets.HOST }}:/tmp/deploy.sh 

          echo "Executing deployment script on server..."
          ssh root@${{ secrets.HOST }} bash -s << 'ENDSSH'
          export SERVER_NAME='${{ secrets.SERVER_NAME }}'
          export ADMIN_EMAIL='${{ secrets.ADMIN_EMAIL }}'
          export DJANGO_SUPERUSER_USERNAME='${{ secrets.DJANGO_SUPERUSER_USERNAME }}'
          export DJANGO_SUPERUSER_EMAIL='${{ secrets.DJANGO_SUPERUSER_EMAIL }}'
          export DJANGO_SUPERUSER_PASSWORD='${{ secrets.DJANGO_SUPERUSER_PASSWORD }}'
          bash /tmp/deploy.sh
          ENDSSH

          echo "Cleaning up deployment script..."
          ssh root@${{ secrets.HOST }} "rm /tmp/deploy.sh"

          echo "Deployment workflow completed!"
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Map | SpotMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#6366F1',
                        accent: '#10B981'
                    }
                }
            }
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .map-container {
            position: relative;
            overflow: hidden;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }

        .map-container:active {
            cursor: grabbing;
        }

        .map-image {
            transition: transform 0.2s ease;
            max-width: none;
            display: block;
            will-change: transform;
        }

        .zoom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 20;
        }

        .search-dropdown {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .search-dropdown::-webkit-scrollbar {
            width: 4px;
        }

        .search-dropdown::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .result-item {
            transition: all 0.2s ease;
        }

        .result-item:hover {
            transform: translateX(4px);
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        @media (prefers-reduced-motion: reduce) {
            * {
                transition-duration: 0.01ms !important;
                animation-duration: 0.01ms !important;
            }
        }

        /* Add these enhanced styles to your existing <style> section */

/* Improved Modal Overlay with blur effect */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(30, 58, 138, 0.6) 100%);
    backdrop-filter: blur(10px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    animation: fadeIn 0.3s ease-out;
}

/* Enhanced Modal Content */
.modal-content {
    background: white;
    border-radius: 2rem;
    max-width: 95vw;
    max-height: 95vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6), 
                0 0 100px rgba(59, 130, 246, 0.3);
    display: flex;
    flex-direction: column;
    animation: modalSlideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes modalSlideUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Enhanced Modal Header with gradient */
.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid rgba(229, 231, 235, 0.8);
    background: linear-gradient(135deg, rgb(249, 250, 251) 0%, rgb(239, 246, 255) 50%, rgb(243, 244, 246) 100%);
    position: relative;
    overflow: hidden;
}

.modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Enhanced Modal Body */
.modal-body {
    flex: 1;
    overflow: hidden;
    position: relative;
    background: linear-gradient(135deg, rgb(248, 250, 252) 0%, rgb(241, 245, 249) 100%);
    touch-action: none;
}

/* Image Wrapper with subtle pattern */
.modal-image-wrapper {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-image: 
        radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

/* Enhanced Map Image */
.modal-map-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transform-origin: center center;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    filter: drop-shadow(0 10px 25px rgba(0, 0, 0, 0.15));
    border-radius: 0.5rem;
}

.modal-map-image:active {
    cursor: grabbing;
    transition: transform 0.1s ease;
}

/* Enhanced Zoom Controls */
.modal-zoom-controls {
    position: absolute;
    bottom: 2rem;
    right: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    z-index: 10;
}

.modal-zoom-btn {
    width: 3.5rem;
    height: 3.5rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 
                0 2px 4px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
}

.modal-zoom-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-zoom-btn:hover::before {
    opacity: 1;
}

.modal-zoom-btn:hover {
    background: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 
                0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: rgba(59, 130, 246, 0.2);
}

.modal-zoom-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.modal-zoom-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
}

.modal-zoom-btn i {
    position: relative;
    z-index: 1;
    font-size: 1rem;
    transition: transform 0.3s ease;
}

.modal-zoom-btn:hover i {
    transform: scale(1.1);
}

/* Enhanced Info Badges */
.modal-info-badge {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
    padding: 0.75rem 1.25rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(55, 65, 81);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 
                0 2px 4px rgba(0, 0, 0, 0.06);
    z-index: 10;
    border: 1px solid rgba(0, 0, 0, 0.05);
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Enhanced Gesture Hint */
.modal-gesture-hint {
    position: absolute;
    bottom: 2rem;
    left: 2rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(139, 92, 246, 0.95));
    backdrop-filter: blur(12px);
    padding: 1rem 1.5rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    color: white;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 
                0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
    animation: bounceIn 0.6s ease-out 0.3s both;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
    }
    60% {
        opacity: 1;
        transform: translateY(-5px) scale(1.02);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Responsive adjustments */
@media (max-width: 640px) {
    .modal-content {
        border-radius: 1.5rem;
        max-width: 100vw;
        max-height: 100vh;
    }

    .modal-header {
        padding: 1rem 1.25rem;
    }

    .modal-zoom-controls {
        bottom: 1rem;
        right: 1rem;
        gap: 0.5rem;
    }

    .modal-zoom-btn {
        width: 3rem;
        height: 3rem;
    }

    .modal-info-badge {
        top: 1rem;
        left: 1rem;
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
    }

    .modal-gesture-hint {
        bottom: 1rem;
        left: 1rem;
        font-size: 0.75rem;
        padding: 0.75rem 1rem;
    }
}

@media (min-width: 1024px) {
    .modal-content {
        max-width: 90vw;
        max-height: 90vh;
    }
}

/* Close button enhancement */
#close-modal {
    position: relative;
    overflow: hidden;
}

#close-modal::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(239, 68, 68, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

#close-modal:hover::before {
    opacity: 1;
}

#close-modal i {
    transition: transform 0.3s ease;
}

#close-modal:hover i {
    transform: rotate(90deg);
}

/* Loading state enhancement */
.modal-body .animate-spin {
    animation: spin 1s linear infinite;
    filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <!-- Compact Navigation -->
    <nav class="glass sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            <div class="flex items-center justify-between h-12">
                <div class="flex items-center space-x-2">
                    <div
                        class="w-7 h-7 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-white text-xs"></i>
                    </div>
                    <h1
                        class="text-lg font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        SpotMe
                    </h1>
                </div>
                <button id="back-button"
                    class="px-3 py-1.5 bg-white/60 hover:bg-white/80 text-gray-700 rounded-lg text-sm font-medium transition-all">
                    <i class="fas fa-arrow-left mr-1"></i>Back
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
        <!-- Compact Event Header -->
        <div class="glass rounded-2xl p-4 mb-4 slide-up">
            <div class="flex items-center justify-between">
                <div class="min-w-0 flex-1">
                    <!-- Replace the placeholder text with actual Django template variables -->
                    <h2 class="text-xl font-bold text-gray-900 truncate mb-1">{{ event.name }}</h2>
                    <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                        <span class="flex items-center gap-1">
                            <i class="fas fa-map-marker-alt text-blue-500 text-xs"></i>
                            {{ event.venue }}
                        </span>
                        <span class="flex items-center gap-1">
                            <i class="fas fa-calendar text-blue-500 text-xs"></i>
                            {{ event.date|date:"M d, Y" }}
                        </span>
                        {% if event.time %}
                        <span class="flex items-center gap-1">
                            <i class="fas fa-clock text-blue-500 text-xs"></i>
                            {{ event.time|time:"g:i A" }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="ml-4 hidden sm:block">
                    <div
                        class="w-16 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-building text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Search Panel -->
            <div class="lg:col-span-1">
                <div class="glass rounded-2xl p-4 fade-in">
                    <div class="flex items-center gap-2 mb-3">
                        <div
                            class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h3 class="font-semibold text-gray-900">Find Seat</h3>
                    </div>

                    <!-- Search Input -->
                    <div class="relative mb-3">
                        <input type="text" id="attendee-search" placeholder="Search attendee name..."
                            class="w-full pl-10 pr-10 py-3 bg-white/60 border border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors text-sm"
                            autocomplete="off" aria-label="Search for attendee by name">
                        <i
                            class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                        <button id="clear-search"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden transition-colors">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>

                    <!-- Search Tips -->
                    <div class="bg-blue-50 p-3 rounded-xl mb-3 text-xs text-blue-800">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-info-circle flex-shrink-0 mt-0.5"></i>
                            <div>
                                <p class="font-semibold mb-1">Quick Tips:</p>
                                <ul class="space-y-0.5">
                                    <li>• Type at least 2 characters</li>
                                    <li>• Use partial names for faster results</li>
                                    <li>• Press Ctrl+K to focus search</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="search-loading" class="hidden text-center py-4">
                        <div
                            class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2">
                        </div>
                        <p class="text-sm text-gray-600">Searching...</p>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="search-dropdown space-y-2 hidden"></div>

                    <!-- Recent Searches -->
                    <div id="recent-searches" class="mt-4 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Recent Searches</p>
                            <button id="clear-history"
                                class="text-xs text-blue-600 hover:text-blue-700 font-medium">Clear</button>
                        </div>
                        <div id="recent-searches-list" class="space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Map Panel -->
            <div class="lg:col-span-2">
                <div class="glass rounded-2xl overflow-hidden fade-in">
                    <!-- Map Header -->
                    <div class="flex items-center justify-between p-4 border-b border-white/30">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-building text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Venue Map</h3>
                                <p class="text-xs text-gray-600">Drag to pan • Scroll to zoom</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-sm text-gray-600 font-medium">
                                <span id="zoom-level">100%</span>
                            </div>
                            <button id="fullscreen-toggle"
                                class="w-8 h-8 bg-white/60 hover:bg-white/80 text-gray-700 rounded-lg flex items-center justify-center transition-colors">
                                <i class="fas fa-expand text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div class="map-container h-64 sm:h-80 lg:h-96 bg-gradient-to-br from-gray-50 to-blue-50 relative"
                        id="map-container">
                        <div class="flex items-center justify-center h-full text-center text-gray-500">
                            <div>
                                <div
                                    class="w-16 h-16 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-building text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-semibold mb-2">Interactive Venue Floor Plan</h4>
                                <p class="text-sm text-gray-400 max-w-sm mx-auto">
                                    The venue map will be displayed here. Use zoom controls or mouse wheel to navigate.
                                </p>
                            </div>
                        </div>

                        <!-- Zoom Controls -->
                        <div class="zoom-controls flex flex-col gap-1">
                            <button id="zoom-in"
                                class="w-8 h-8 bg-white/90 hover:bg-white text-gray-700 rounded-lg flex items-center justify-center shadow-md transition-all hover:scale-110"
                                title="Zoom In">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button id="zoom-out"
                                class="w-8 h-8 bg-white/90 hover:bg-white text-gray-700 rounded-lg flex items-center justify-center shadow-md transition-all hover:scale-110"
                                title="Zoom Out">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <button id="zoom-reset"
                                class="w-8 h-8 bg-white/90 hover:bg-white text-gray-700 rounded-lg flex items-center justify-center shadow-md transition-all hover:scale-110"
                                title="Reset View">
                                <i class="fas fa-expand text-xs"></i>
                            </button>
                            <button id="zoom-fit"
                                class="w-8 h-8 bg-white/90 hover:bg-white text-gray-700 rounded-lg flex items-center justify-center shadow-md transition-all hover:scale-110"
                                title="Fit to Screen">
                                <i class="fas fa-compress text-xs"></i>
                            </button>
                        </div>

                        <!-- Mini Map -->
                        <div id="mini-map"
                            class="hidden absolute bottom-4 left-4 w-32 h-24 bg-white/90 rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                            <div class="w-full h-full bg-gray-100"></div>
                        </div>
                    </div>

                    <!-- Map Legend -->
                    <div class="p-4 bg-gradient-to-r from-gray-50 to-blue-50 border-t border-white/30">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-4 text-xs">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span class="text-gray-600 font-medium">Available</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <span class="text-gray-600 font-medium">Occupied</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                    <span class="text-gray-600 font-medium">Selected</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-keyboard mr-1"></i>
                                <span class="font-medium">Keyboard:</span> Ctrl+K to search, ESC to clear
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function () {
            // CSRF Token Setup (CRITICAL FOR DJANGO)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });

            // Configuration
            const config = {
                eventId: {{ event.id }},
                searchMinLength: 2,
                searchDebounce: 300,
                maxRecentSearches: 5,
                zoom: {
                    min: 0.5,
                    max: 3,
                    step: 0.2,
                    default: 1
                }
            };

        // State - ADD $mapImage reference
        const state = {
            currentZoom: config.zoom.default,
            currentX: 0,
            currentY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            searchHistory: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
            $mapImage: null
        };

        // jQuery element cache
        const $elements = {
            searchInput: $('#attendee-search'),
            clearSearchBtn: $('#clear-search'),
            searchResults: $('#search-results'),
            searchLoading: $('#search-loading'),
            recentSearches: $('#recent-searches'),
            recentSearchesList: $('#recent-searches-list'),
            clearHistoryBtn: $('#clear-history'),
            mapContainer: $('#map-container'),
            zoomLevel: $('#zoom-level'),
            zoomInBtn: $('#zoom-in'),
            zoomOutBtn: $('#zoom-out'),
            zoomResetBtn: $('#zoom-reset'),
            zoomFitBtn: $('#zoom-fit'),
            fullscreenBtn: $('#fullscreen-toggle'),
            backBtn: $('#back-button')
        };

        // Initialize
        init();

        function init() {
            loadEventData();
            setupEventListeners();
            loadRecentSearches();
            initializeZoomControls();
            focusSearch();
            showWelcomeToast();
        }

        function loadEventData() {
            $.ajax({
                url: `/api/events/${config.eventId}/map-data/`,
                method: 'GET',
                success: function (data) {
                    console.log('Event data loaded:', data);
                    if (data.success && data.event) {
                        updateEventHeader(data.event);
                        if (data.event.seat_map_url) {
                            loadFloorPlanImage(data.event.seat_map_url);
                        }
                    }
                },
                error: function (xhr) {
                    console.error('Failed to load event data:', xhr.status, xhr.responseText);
                    showToast('Failed to load event data', 'error');
                }
            });
        }

        function updateEventHeader(event) {
            // Update event details if needed (template already has them)
            console.log('Event details:', event);
        }

        function loadFloorPlanImage(imageUrl) {
    const $mapContainer = $elements.mapContainer;

    $mapContainer.html('<div class="flex items-center justify-center h-full"><div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>');

    const $wrapper = $('<div class="absolute inset-0 flex items-center justify-center overflow-hidden"></div>');

    // Ensure imageUrl is absolute
    const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl;

    const $img = $('<img>')
        .attr('src', fullImageUrl)
        .attr('alt', 'Venue floor plan')
        .addClass('map-image max-w-full max-h-full object-contain')
        .css({
            'position': 'relative',
            'transform-origin': 'center center',
            'transform': `translate(${state.currentX}px, ${state.currentY}px) scale(${state.currentZoom})`,
            'transition': 'transform 0.2s ease'
        })
        .on('load', function () {
            console.log('Floor plan loaded successfully');
            $mapContainer.empty();
            $wrapper.append($img);
            $mapContainer.append($wrapper);
            state.$mapImage = $img;
            loadSeatMarkers();
            showToast('Floor plan loaded successfully', 'success');
        })
        .on('error', function (e) {
            console.error('Floor plan load error:', e, 'URL:', fullImageUrl);
            $mapContainer.html(`
                <div class="flex items-center justify-center h-full text-center text-gray-500 p-4">
                    <div>
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <h4 class="text-lg font-semibold mb-2">Failed to load floor plan</h4>
                        <p class="text-sm mb-2">The venue map image could not be loaded.</p>
                        <p class="text-xs text-gray-400">URL: ${fullImageUrl}</p>
                        <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
                            <i class="fas fa-redo mr-1"></i>Retry
                        </button>
                    </div>
                </div>
            `);
            showToast('Failed to load floor plan image', 'error');
        });
}
        function loadSeatMarkers() {
            $.ajax({
                url: `/api/events/${config.eventId}/statistics/`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.sections_statistics) {
                        console.log('Seat data loaded:', data);
                    }
                }
            });
        }

        
        function handleSearchInput() {
            const query = $elements.searchInput.val().trim();
            console.log('Search input:', query);

            $elements.clearSearchBtn.toggle(query.length > 0);

            if (query.length === 0) {
                hideSearch();
                loadRecentSearches();
                return;
            }

            if (query.length < config.searchMinLength) {
                return;
            }

            performSearch(query);
        }

        function performSearch(query) {
    console.log('Performing search for:', query);
    showLoading();

    $.ajax({
        url: '/api/search/attendee/',
        method: 'GET',
        data: {
            q: query,
            event_id: config.eventId,
            limit: 10
        },
        dataType: 'json',
        success: function (data) {
            console.log('Search response:', data);
            hideLoading();
            
            if (data.success && data.results) {
                displayResults(data.results, query);
                if (data.results.length > 0) {
                    addToSearchHistory(query);
                }
            } else {
                console.error('Search error:', data.error || data.message);
                showToast(data.error || data.message || 'Search failed', 'error');
                $elements.searchResults.html(createNoResultsHTML(query)).removeClass('hidden');
            }
        },
        error: function (xhr, status, error) {
            console.error('Search AJAX error:', xhr.status, xhr.responseText);
            hideLoading();
            
            let errorMessage = 'Search failed. Please try again.';
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMessage = errorData.error || errorData.message || errorMessage;
            } catch (e) {
                errorMessage = xhr.statusText || errorMessage;
            }
            
            showToast(errorMessage, 'error');
            $elements.searchResults.html(createNoResultsHTML(query)).removeClass('hidden');
        }
    });
}
        function displayResults(results, query) {
            if (results.length === 0) {
                $elements.searchResults.html(createNoResultsHTML(query)).removeClass('hidden');
                return;
            }

            const resultsHTML = `
            <div class="mb-3 pb-2 border-b border-gray-200/50">
                <p class="text-xs text-gray-500 font-medium">Found ${results.length} result${results.length !== 1 ? 's' : ''}</p>
            </div>
            ${results.map((attendee, index) => createResultItemHTML(attendee, index)).join('')}
        `;

            $elements.searchResults.html(resultsHTML).removeClass('hidden');
            $elements.recentSearches.addClass('hidden');
        }

        

        function createNoResultsHTML(query) {
            return `
            <div class="text-center py-8 text-gray-500">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-search text-xl opacity-50"></i>
                </div>
                <p class="text-sm font-medium mb-1">No attendees found</p>
                <p class="text-xs text-gray-400">Try checking spelling or use partial names</p>
            </div>
        `;
        }

        function handleResultClick() {
            const attendee = JSON.parse($(this).attr('data-attendee'));
            showSeatInfo(attendee);
        }

        function showSeatInfo(attendee) {
            Swal.fire({
                title: `<div class="flex items-center gap-2 justify-center"><i class="fas fa-chair text-blue-500"></i><span>Seat Information</span></div>`,
                html: createSeatInfoHTML(attendee),
                icon: null,
                confirmButtonText: '<i class="fas fa-check mr-2"></i>Got it!',
                confirmButtonColor: '#3B82F6',
                showCancelButton: true,
                cancelButtonText: '<i class="fas fa-directions mr-2"></i>Show on Map',
                cancelButtonColor: '#10B981',
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'rounded-lg',
                    cancelButton: 'rounded-lg'
                },
                width: '90%',
                maxWidth: '400px'
                // Find this section in showSeatInfo function and replace:
            }).then((result) => {
                if (result.isDismiss && result.dismiss === Swal.DismissReason.cancel) {
                    openFloorPlanModal(attendee);
                }
            });
        }

        function createSeatInfoHTML(attendee) {
            return `
            <div class="text-left space-y-4">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900">${attendee.name}</p>
                            <p class="text-sm text-gray-600">Ticket: ${attendee.ticket_number}</p>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-50 p-3 rounded-xl text-center">
                        <i class="fas fa-layer-group text-gray-600 mb-1"></i>
                        <p class="text-xs text-gray-600">Section</p>
                        <p class="font-bold text-sm">${attendee.section}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl text-center">
                        <i class="fas fa-grip-lines text-gray-600 mb-1"></i>
                        <p class="text-xs text-gray-600">Row</p>
                        <p class="font-bold text-sm">${attendee.row}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl text-center">
                        <i class="fas fa-chair text-gray-600 mb-1"></i>
                        <p class="text-xs text-gray-600">Seat</p>
                        <p class="font-bold text-sm">${attendee.seat}</p>
                    </div>
                </div>
            </div>
        `;
        }

        function applyTransform() {
            if (state.$mapImage && state.$mapImage.length) {
                state.$mapImage.css('transform', `translate(${state.currentX}px, ${state.currentY}px) scale(${state.currentZoom})`);
            }
        }

        function adjustZoom(delta) {
            const newZoom = Math.max(config.zoom.min, Math.min(config.zoom.max, state.currentZoom + delta));
            if (newZoom !== state.currentZoom) {
                state.currentZoom = newZoom;
                updateZoomDisplay();
                updateZoomButtons();
                applyTransform();
            }
        }

        function resetZoom() {
            state.currentZoom = config.zoom.default;
            state.currentX = 0;
            state.currentY = 0;
            updateZoomDisplay();
            updateZoomButtons();
            applyTransform();
            showToast('View reset to default', 'info');
        }

        function fitToScreen() {
            state.currentZoom = 1;
            state.currentX = 0;
            state.currentY = 0;
            updateZoomDisplay();
            updateZoomButtons();
            applyTransform();
            showToast('Map fitted to screen', 'info');
        }

        function updateZoomDisplay() {
            $elements.zoomLevel.text(Math.round(state.currentZoom * 100) + '%');
        }

        function updateZoomButtons() {
            $elements.zoomInBtn.prop('disabled', state.currentZoom >= config.zoom.max)
                .toggleClass('opacity-50 cursor-not-allowed', state.currentZoom >= config.zoom.max);

            $elements.zoomOutBtn.prop('disabled', state.currentZoom <= config.zoom.min)
                .toggleClass('opacity-50 cursor-not-allowed', state.currentZoom <= config.zoom.min);

            const isDefault = state.currentZoom === config.zoom.default && state.currentX === 0 && state.currentY === 0;
            $elements.zoomResetBtn.prop('disabled', isDefault)
                .toggleClass('opacity-50 cursor-not-allowed', isDefault);
        }

        function handleMouseWheel(e) {
            e.preventDefault();
            const delta = e.originalEvent.deltaY > 0 ? -config.zoom.step : config.zoom.step;
            adjustZoom(delta);
        }

        function startDrag(e) {
            if (state.currentZoom <= 1) return;
            state.isDragging = true;
            const event = e.type === 'touchstart' ? e.originalEvent.touches[0] : e;
            state.lastX = event.clientX;
            state.lastY = event.clientY;
            $elements.mapContainer.css('cursor', 'grabbing');
            e.preventDefault();
        }

        function handleDrag(e) {
            if (!state.isDragging) return;
            const event = e.type === 'touchmove' ? e.originalEvent.touches[0] : e;
            const deltaX = event.clientX - state.lastX;
            const deltaY = event.clientY - state.lastY;
            state.currentX += deltaX;
            state.currentY += deltaY;
            state.lastX = event.clientX;
            state.lastY = event.clientY;
            applyTransform();
            e.preventDefault();
        }

        function endDrag() {
            if (state.isDragging) {
                state.isDragging = false;
                $elements.mapContainer.css('cursor', state.currentZoom > 1 ? 'grab' : 'default');
            }
        }

        function addToSearchHistory(query) {
            state.searchHistory = state.searchHistory.filter(item => item.toLowerCase() !== query.toLowerCase());
            state.searchHistory.unshift(query);
            state.searchHistory = state.searchHistory.slice(0, config.maxRecentSearches);
            localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
        }

        function loadRecentSearches() {
            if (state.searchHistory.length === 0) {
                $elements.recentSearches.addClass('hidden');
                return;
            }

            const historyHTML = state.searchHistory.map(query => `
            <div class="recent-search-item p-2 bg-white/40 hover:bg-white/60 rounded-lg cursor-pointer transition-all text-sm flex items-center justify-between group"
                 data-query="${query}">
                <div class="flex items-center gap-2">
                    <i class="fas fa-history text-gray-400 text-xs"></i>
                    <span class="text-gray-700">${query}</span>
                </div>
                <i class="fas fa-arrow-right text-gray-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
        `).join('');

            $elements.recentSearchesList.html(historyHTML);
            $elements.recentSearches.removeClass('hidden');
        }

        function handleRecentSearchClick() {
            const query = $(this).data('query');
            $elements.searchInput.val(query);
            performSearch(query);
        }

        function clearSearchHistory() {
            state.searchHistory = [];
            localStorage.removeItem('searchHistory');
            $elements.recentSearches.addClass('hidden');
            showToast('Search history cleared', 'success');
        }

        function clearSearch() {
            $elements.searchInput.val('').focus();
            hideSearch();
            loadRecentSearches();
        }

        function hideSearch() {
            $elements.clearSearchBtn.addClass('hidden');
            $elements.searchResults.addClass('hidden').empty();
        }

        function showLoading() {
            $elements.searchLoading.removeClass('hidden');
            $elements.searchResults.addClass('hidden');
            $elements.recentSearches.addClass('hidden');
        }

        function hideLoading() {
            $elements.searchLoading.addClass('hidden');
        }

        function initializeZoomControls() {
            updateZoomButtons();
        }

        function toggleFullscreen() {
            const container = $elements.mapContainer[0];
            if (!document.fullscreenElement) {
                container.requestFullscreen().then(() => {
                    $elements.fullscreenBtn.find('i').removeClass('fa-expand').addClass('fa-compress');
                    showToast('Entered fullscreen mode', 'info');
                }).catch(err => {
                    showToast('Could not enter fullscreen', 'error');
                });
            } else {
                document.exitFullscreen().then(() => {
                    $elements.fullscreenBtn.find('i').removeClass('fa-compress').addClass('fa-expand');
                    showToast('Exited fullscreen mode', 'info');
                });
            }
        }

        function handleKeyboard(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                focusSearch();
            }
            if (e.key === 'Escape' && $elements.searchInput.val()) {
                clearSearch();
            }
            if (e.key === '+' || e.key === '=') {
                e.preventDefault();
                adjustZoom(config.zoom.step);
            }
            if (e.key === '-' || e.key === '_') {
                e.preventDefault();
                adjustZoom(-config.zoom.step);
            }
            if (e.key === '0') {
                e.preventDefault();
                resetZoom();
            }
        }

        function focusSearch() {
            $elements.searchInput.focus();
        }

        function showWelcomeToast() {
            setTimeout(() => {
                showToast('Welcome! Use Ctrl+K to quickly search for attendees', 'info');
            }, 500);
        }

        function showToast(message, type = 'success') {
    // Remove any existing toasts
    $('.toast-container').remove();
    
    const icons = {
        success: 'fa-check-circle text-green-500',
        error: 'fa-exclamation-circle text-red-500',
        info: 'fa-info-circle text-blue-500',
        warning: 'fa-exclamation-triangle text-yellow-500'
    };

    const icon = icons[type] || icons.info;
    const borderColor = type === 'error' ? 'border-red-500' : type === 'warning' ? 'border-yellow-500' : type === 'info' ? 'border-blue-500' : 'border-green-500';

    const $toast = $(`
        <div class="toast-container fixed top-6 right-6 z-50 max-w-md fade-in" style="animation: fadeIn 0.3s ease-in;">
            <div class="glass border-l-4 ${borderColor} rounded-2xl shadow-2xl p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas ${icon} text-xl"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-semibold text-gray-800">${message}</p>
                    </div>
                    <button class="ml-3 text-gray-400 hover:text-gray-600 transition-colors close-toast-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `);

    $('body').append($toast);

    $toast.find('.close-toast-btn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $toast.fadeOut(300, function() {
            $(this).remove();
        });
    });

    setTimeout(() => {
        $toast.fadeOut(300, function() {
            $(this).remove();
        });
    }, 4000);
}

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        

        
        function showModalError($container) {
            $container.html(`
        <div class="flex items-center justify-center h-full text-center p-6">
            <div>
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-900 mb-2">Unable to Load Floor Plan</h4>
                <p class="text-gray-600 mb-4">The venue map could not be loaded at this time.</p>
                <button onclick="closeFloorPlanModal()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>
        </div>
    `);
        }

   function createResultItemHTML(attendee, index) {
    // Create a clean copy of attendee data
    const attendeeData = {
        name: attendee.name,
        section: attendee.section,
        row: attendee.row,
        seat: attendee.seat,
        seat_info: attendee.seat_info,
        ticket_number: attendee.ticket_number
    };
    
    return `
        <div class="result-item p-3 bg-white/60 hover:bg-white/80 rounded-lg transition-all cursor-pointer slide-up" 
             style="animation-delay: ${index * 50}ms"
             data-attendee='${JSON.stringify(attendeeData).replace(/'/g, "&#39;")}'>
            <div class="flex items-center justify-between">
                <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-md flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-white text-xs"></i>
                        </div>
                        <h4 class="font-medium text-gray-900 truncate text-sm">${attendee.name}</h4>
                    </div>
                    <div class="text-xs text-gray-600 space-y-0.5 ml-8">
                        <p><i class="fas fa-layer-group w-3"></i> Section ${attendee.section} • ${attendee.seat_info}</p>
                        <p><i class="fas fa-ticket-alt w-3"></i> ${attendee.ticket_number}</p>
                    </div>
                </div>
                <button class="show-on-map-btn ml-2 w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white rounded-lg flex items-center justify-center transition-all hover:scale-110 flex-shrink-0" 
                        title="View on Map">
                    <i class="fas fa-map-marked-alt text-xs"></i>
                </button>
            </div>
        </div>
    `;
}
function setupEventListeners() {
    $elements.searchInput.on('input', debounce(handleSearchInput, config.searchDebounce));
    $elements.clearSearchBtn.on('click', clearSearch);
    $elements.clearHistoryBtn.on('click', clearSearchHistory);
    $elements.backBtn.on('click', () => window.history.back());

    $elements.zoomInBtn.on('click', () => adjustZoom(config.zoom.step));
    $elements.zoomOutBtn.on('click', () => adjustZoom(-config.zoom.step));
    $elements.zoomResetBtn.on('click', resetZoom);
    $elements.zoomFitBtn.on('click', fitToScreen);
    $elements.fullscreenBtn.on('click', toggleFullscreen);

    $elements.mapContainer.on('wheel', handleMouseWheel);
    $elements.mapContainer.on('mousedown touchstart', startDrag);
    $(document).on('mousemove touchmove', handleDrag);
    $(document).on('mouseup touchend', endDrag);

    $(document).on('keydown', handleKeyboard);
    
    // Handle result item clicks (but not the map button)
    $(document).on('click', '.result-item', function(e) {
        // Don't trigger if clicking the map button
        if ($(e.target).closest('.show-on-map-btn').length > 0) {
            return;
        }
        
        try {
            const attendeeJson = $(this).attr('data-attendee');
            if (attendeeJson) {
                const attendee = JSON.parse(attendeeJson);
                openFloorPlanModal(attendee);
            }
        } catch (error) {
            console.error('Error parsing attendee data:', error);
            showToast('Failed to load attendee information', 'error');
        }
    });
    
    // Handle "Show on Map" button clicks
    $(document).on('click', '.show-on-map-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        try {
            const $resultItem = $(this).closest('.result-item');
            const attendeeJson = $resultItem.attr('data-attendee');
            
            if (attendeeJson) {
                const attendee = JSON.parse(attendeeJson);
                console.log('Opening map for:', attendee);
                openFloorPlanModal(attendee);
            } else {
                console.error('No attendee data found');
                showToast('Failed to load attendee information', 'error');
            }
        } catch (error) {
            console.error('Error opening map:', error);
            showToast('Failed to open floor plan', 'error');
        }
    });
    
    $(document).on('click', '.recent-search-item', handleRecentSearchClick);
}
function openFloorPlanModal(attendee = null) {
    const modalHTML = `
        <div class="modal-overlay" id="floor-plan-modal">
            <div class="modal-content" style="width: 90vw; height: 85vh;">
                <div class="modal-header">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-map-marked-alt text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900 text-lg">Venue Floor Plan</h3>
                            ${attendee ? `
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-user text-blue-500 mr-1"></i>${attendee.name} 
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-layer-group text-purple-500 mr-1"></i>Section ${attendee.section} 
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-chair text-green-500 mr-1"></i>Row ${attendee.row}, Seat ${attendee.seat}
                                </p>
                            ` : '<p class="text-sm text-gray-600">Interactive venue map with zoom and pan controls</p>'}
                        </div>
                    </div>
                    <button id="close-modal" class="w-10 h-10 hover:bg-gray-100 rounded-xl flex items-center justify-center transition-all hover:scale-110">
                        <i class="fas fa-times text-gray-600 text-xl"></i>
                    </button>
                </div>
                <div class="modal-body" id="modal-map-body">
                    <div class="flex items-center justify-center h-full flex-col gap-4">
                        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <p class="text-gray-600 font-medium">Loading venue floor plan...</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    $('body').append(modalHTML);

    const $modal = $('#floor-plan-modal');
    const $modalBody = $('#modal-map-body');

    // Prevent body scroll
    $('body').css('overflow', 'hidden');

    // Load the floor plan
    $.ajax({
        url: `/api/events/${config.eventId}/map-data/`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.event && data.event.seat_map_url) {
                loadModalFloorPlan(data.event.seat_map_url, $modalBody, attendee);
            } else {
                showModalError($modalBody);
            }
        },
        error: function () {
            showModalError($modalBody);
        }
    });

    // Close modal handlers
    $modal.on('click', function (e) {
        if (e.target.id === 'floor-plan-modal') {
            closeFloorPlanModal();
        }
    });

    $('#close-modal').on('click', closeFloorPlanModal);

    $(document).on('keydown.modal', function (e) {
        if (e.key === 'Escape') {
            closeFloorPlanModal();
        }
    });
}

// Enhanced loadModalFloorPlan with seat marker:

function loadModalFloorPlan(imageUrl, $container, attendee) {
    let modalZoom = 1;
    let modalX = 0;
    let modalY = 0;
    let isDragging = false;
    let lastX = 0;
    let lastY = 0;
    let touchStartDistance = 0;
    let initialZoom = 1;

    const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl;

    const $wrapper = $('<div class="modal-image-wrapper"></div>');
    const $img = $('<img>')
        .attr('src', fullImageUrl)
        .addClass('modal-map-image')
        .css('transform', `translate(${modalX}px, ${modalY}px) scale(${modalZoom})`);

    // Enhanced info badges
    const $zoomInfo = $(`
        <div class="modal-info-badge">
            <i class="fas fa-search-plus mr-2"></i>
            <span id="modal-zoom-level">100%</span>
        </div>
    `);

    const $gestureHint = $(`
        <div class="modal-gesture-hint">
            <i class="fas fa-hand-pointer mr-2"></i>
            <span>Pinch or scroll to zoom • Drag to pan</span>
        </div>
    `);

    // Add attendee location badge if available
    let $locationBadge = null;
    if (attendee) {
        $locationBadge = $(`
            <div style="position: absolute; top: 4.5rem; left: 1rem; background: rgba(16, 185, 129, 0.95); backdrop-filter: blur(12px); padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 10; animation: fadeIn 0.5s ease-out 0.3s both;">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    <div class="text-sm font-semibold">
                        <i class="fas fa-map-pin mr-1"></i>
                        Section ${attendee.section} • Row ${attendee.row} • Seat ${attendee.seat}
                    </div>
                </div>
            </div>
        `);
    }

    // Enhanced zoom controls with tooltips
    const $zoomControls = $(`
        <div class="modal-zoom-controls">
            <button class="modal-zoom-btn" id="modal-zoom-in" title="Zoom In (+ key)">
                <i class="fas fa-plus text-gray-700"></i>
            </button>
            <button class="modal-zoom-btn" id="modal-zoom-out" title="Zoom Out (- key)">
                <i class="fas fa-minus text-gray-700"></i>
            </button>
            <button class="modal-zoom-btn" id="modal-zoom-reset" title="Reset View (0 key)">
                <i class="fas fa-expand-arrows-alt text-gray-700"></i>
            </button>
            <button class="modal-zoom-btn" id="modal-zoom-fit" title="Fit to Screen">
                <i class="fas fa-compress-arrows-alt text-gray-700"></i>
            </button>
        </div>
    `);

    $img.on('load', function () {
        $container.empty();
        $wrapper.append($img);
        $container.append($wrapper, $zoomInfo, $gestureHint, $zoomControls);
        
        if ($locationBadge) {
            $container.append($locationBadge);
        }

        // Hide gesture hint after 3 seconds
        setTimeout(() => $gestureHint.fadeOut(500), 3000);

        setupModalZoomControls();
        
        // Show success toast
        showToast('Floor plan loaded! Use controls to zoom and pan', 'success');
    });

    $img.on('error', function () {
        showModalError($container);
    });

    function applyModalTransform() {
        $img.css('transform', `translate(${modalX}px, ${modalY}px) scale(${modalZoom})`);
        $('#modal-zoom-level').text(Math.round(modalZoom * 100) + '%');
        updateModalZoomButtons();
    }

    function updateModalZoomButtons() {
        $('#modal-zoom-in').toggleClass('disabled', modalZoom >= 5);
        $('#modal-zoom-out').toggleClass('disabled', modalZoom <= 0.5);
        $('#modal-zoom-reset').toggleClass('disabled', modalZoom === 1 && modalX === 0 && modalY === 0);
    }

    function setupModalZoomControls() {
        $('#modal-zoom-in').on('click', function () {
            if (modalZoom < 5) {
                modalZoom = Math.min(5, modalZoom + 0.3);
                applyModalTransform();
            }
        });

        $('#modal-zoom-out').on('click', function () {
            if (modalZoom > 0.5) {
                modalZoom = Math.max(0.5, modalZoom - 0.3);
                applyModalTransform();
            }
        });

        $('#modal-zoom-reset').on('click', function () {
            modalZoom = 1;
            modalX = 0;
            modalY = 0;
            applyModalTransform();
            showToast('View reset', 'info');
        });

        $('#modal-zoom-fit').on('click', function () {
            modalZoom = 1;
            modalX = 0;
            modalY = 0;
            applyModalTransform();
            showToast('Fitted to screen', 'info');
        });

        // Mouse wheel zoom
        $container.on('wheel', function (e) {
            e.preventDefault();
            const delta = e.originalEvent.deltaY > 0 ? -0.15 : 0.15;
            modalZoom = Math.max(0.5, Math.min(5, modalZoom + delta));
            applyModalTransform();
        });

        // Drag functionality
        $img.on('mousedown touchstart', function (e) {
            isDragging = true;
            const event = e.type === 'touchstart' ? e.originalEvent.touches[0] : e;
            lastX = event.clientX;
            lastY = event.clientY;

            if (e.type === 'touchstart' && e.originalEvent.touches.length === 2) {
                const touch1 = e.originalEvent.touches[0];
                const touch2 = e.originalEvent.touches[1];
                touchStartDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                initialZoom = modalZoom;
            }
            e.preventDefault();
        });

        $(document).on('mousemove.modalDrag touchmove.modalDrag', function (e) {
            if (!isDragging) return;

            if (e.type === 'touchmove' && e.originalEvent.touches.length === 2) {
                // Pinch zoom
                const touch1 = e.originalEvent.touches[0];
                const touch2 = e.originalEvent.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                const scale = currentDistance / touchStartDistance;
                modalZoom = Math.max(0.5, Math.min(5, initialZoom * scale));
                applyModalTransform();
            } else {
                // Drag
                const event = e.type === 'touchmove' ? e.originalEvent.touches[0] : e;
                const deltaX = event.clientX - lastX;
                const deltaY = event.clientY - lastY;
                modalX += deltaX;
                modalY += deltaY;
                lastX = event.clientX;
                lastY = event.clientY;
                applyModalTransform();
            }
            e.preventDefault();
        });

        $(document).on('mouseup.modalDrag touchend.modalDrag', function () {
            isDragging = false;
        });

        // Keyboard controls for modal
        $(document).on('keydown.modalControls', function(e) {
            if ($('#floor-plan-modal').length) {
                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    $('#modal-zoom-in').click();
                }
                if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    $('#modal-zoom-out').click();
                }
                if (e.key === '0') {
                    e.preventDefault();
                    $('#modal-zoom-reset').click();
                }
            }
        });
    }
}

function closeFloorPlanModal() {
    $(document).off('keydown.modal keydown.modalControls mousemove.modalDrag mouseup.modalDrag touchmove.modalDrag touchend.modalDrag');
    $('#floor-plan-modal').fadeOut(200, function () {
        $(this).remove();
        $('body').css('overflow', '');
    });
}

// Make closeFloorPlanModal globally accessible
window.closeFloorPlanModal = closeFloorPlanModal;
});
    </script>
</body>

</html>